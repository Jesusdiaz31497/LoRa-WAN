//Every min gets temperature and humidity. After 15min or when button is pressed
//send the avarage of the colected data. 

//DHT libraries
#include <Adafruit_Sensor.h>
#include <DHT.h>
#include <DHT_U.h>

//LoRa libraries
#include <lmic.h>
#include <hal/hal.h>
#include <SPI.h>

//OLED libraries
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
Adafruit_SSD1306 oled(128, 32, &Wire, -1);

//Definitions and variables
#define DHTPIN     12
#define DHTPIN1    13
#define DHTPIN2    15
#define DHTTYPE   DHT22

uint8_t     NWKSKEY[16], APPSKEY[16], KEY[16], PAYLOAD[6];    
uint32_t    DEVADDR;
bool      timer_event = false, timer_event1 = false, ext_event = false;
float     temp[3], hum[3];                                                   //Temperature, humidity. One element per DHT
const uint8_t led = 25;

static const unsigned char PROGMEM image_data_Cenicana[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf0, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0x03, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x01, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x00, 0x3f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf8, 0x00, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf8, 0x00, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf8, 0x00, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf8, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf8, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf8, 0x00, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0x00, 0x00, 0x3f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x00, 0x7f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x03, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x07, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0x0f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf0, 0x1f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
//Create one objetct per DHT
DHT dht[]{
          {DHTPIN, DHTTYPE},
          {DHTPIN1, DHTTYPE},
          {DHTPIN2, DHTTYPE},
         };

//LMIC pins
void os_getArtEui (u1_t* buf) { }
void os_getDevEui (u1_t* buf) { }
void os_getDevKey (u1_t* buf) { }
static osjob_t sendjob;

const lmic_pinmap lmic_pins = {
  .nss = 18,                        // CS
  .rxtx = LMIC_UNUSED_PIN,
  .rst = 23,                        // RST
  .dio = {26, 33, 32},              // DIO
};

//Interrupts
hw_timer_t *timer0 = NULL;          //Counts 1 min
hw_timer_t *timer1 = NULL;          //Counts 15 min

void IRAM_ATTR tx_prueba() {
  ext_event = true;
}

void IRAM_ATTR onTimer() {
  timer_event = true;
}

void IRAM_ATTR onTimer1() {
  timer_event1 = true;
}

void setup() {
  Serial.begin(9600);        //PC port

  //OLED initialization
  if (!oled.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println(F("SSD1306 allocation failed"));
    for (;;);                                                 // Don't proceed, loop forever
  }

  pinMode(led, OUTPUT);  digitalWrite(led, LOW);              //Turn led off and initialize LoRa
  Init_Lora();
  
  // Initialize DHTs
  for(int i=0;i<2;i++){
    dht[i].begin(); 
  }

  //Set timmers 0&1, prescaler:80, autoreload, interrupt enable, count up.
  timer0 = timerBegin(0, 80, true);
  timerAttachInterrupt(timer0, &onTimer, true);
  timerAlarmWrite(timer0, 60000000, true);                            //(80M*SEG)/80
  timerAlarmEnable(timer0);

  timer1 = timerBegin(1, 80, true);
  timerAttachInterrupt(timer1, &onTimer1, true);
  timerAlarmWrite(timer1, 900000000, true);                           //(80M*SEG)/80
  timerAlarmEnable(timer1);

  pinMode(38, INPUT);
  attachInterrupt(digitalPinToInterrupt(38), tx_prueba, RISING);
}

void loop() {
  os_runloop_once(); //Make one job in the queue per loop execution
    
  //Get data;
  if(timer_event){
    digitalWrite(led,HIGH);
    
    read_dht();
    display_data();
    
    timer_event = false;
    digitalWrite(led,LOW);
  }

  //Send data
  if(timer_event1){
    digitalWrite(led,HIGH);

    for(int i=0;i<=2;i++){
      temp[i] = temp[i]*5;
      hum[i] = hum[i]*2.5;
    }
            
    do_send(&sendjob);
    
    temp[0] = 0;  hum[0] = 0; temp[1] = 0;  hum[1] = 0; temp[2] = 0;  hum[2] = 0;

    timer_event1 = false;
    digitalWrite(led,LOW);
  }

  if(ext_event){
    digitalWrite(led,HIGH);
    
   read_dht();
   
    for(int i=0;i<=2;i++){
        Serial.print(F("Sensor "));Serial.print(i+1);Serial.print(F(" - T°C: ")); Serial.print(temp[i]);Serial.print(F(" HR: ")); Serial.println(hum[i]);
    }

    for(int i=0;i<=2;i++){
      temp[i] = temp[i]*5;
      hum[i] = hum[i]*2.5;
    }  

    do_send(&sendjob);

    for(int i=0;i<=2;i++){
      temp[i] = temp[i]/5;
      hum[i] = hum[i]/2.5;
    }

    ext_event = false;
    digitalWrite(led,LOW);
  }
}

void read_dht(){
  for(int i=0;i<=2;i++){
        // Get temperature event
        if(temp[i] != 0){
          temp[i] = (temp[i] + dht[i].readTemperature())/2;
        } 
      
        else{
          temp[i] = dht[i].readTemperature();
        }   
    
        // Get humidity event
        if(hum[i] != 0){
          hum[i] = (hum[i] + dht[i].readHumidity())/2;
        } 
        else{
          hum[i] = dht[i].readHumidity();    
        }
   }
}

void display_data(){   
  oled.clearDisplay();            // clear display
  oled.setTextSize(1);            // set text size
  oled.setTextColor(WHITE);       // set text color 
        
  for(int i=0;i<=2;i++){
        oled.clearDisplay();             // clear display
        
        oled.setCursor(40, 0);           // set position to display   x,y 
        oled.println("Cenicana");        // set text
        
        Serial.print(F("Sensor "));Serial.print(i+1);
        oled.setCursor(0, 8);
        oled.println("Sensor");
        oled.setCursor(40, 8);
        oled.println(i+1);
        
        if (isnan(temp[i])) {
          Serial.print(F(" - Error T°"));
          oled.setCursor(0, 16);
          oled.println("Error T");
        }
        else{
          Serial.print(F(" - T°C: ")); Serial.print(temp[i]);
          oled.setCursor(0, 16);
          oled.println("T.C:");
          oled.setCursor(40, 16);
          oled.println(temp[i]);
        }

        if (isnan(hum[i])) {
          Serial.println(F(" - Error HR"));
          oled.setCursor(0, 24);
          oled.println("Error HR");
        }
        else{
          Serial.print(F(" HR: ")); Serial.println(hum[i]);
          oled.setCursor(0, 24);
          oled.println("HR:");
          oled.setCursor(40, 24);
          oled.println(hum[i]);
        }

        oled.display();       // display on OLED
        delay(2500);
  }

  oled.clearDisplay();            // clear display
  oled.setTextSize(1);            // set text size
  oled.setTextColor(WHITE);       // set text color

  oled.drawBitmap(0, 0, image_data_Cenicana, 128, 32, SSD1306_WHITE);
  oled.display();
}
